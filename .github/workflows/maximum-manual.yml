name: üêç Maximum Kart (Python Hybrid)

on:
  workflow_dispatch:
  schedule:
    - cron: '15 4 * * *' # Run at 07:15 TRT (04:15 UTC) daily

jobs:
  scrape-python:
    name: üêç Scrape Maximum (Python)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Setup Python Environment
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Python Dependencies
        run: |
          pip install -r requirements.txt
          # Additional check for chrome
          google-chrome --version || true

      # 2. Setup Node.js (for Import Script)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node Dependencies
        run: npm ci

      # 3. Run Python Scraper with Xvfb (Virtual Display)
      # using xvfb-run allows "headful" chrome to run in headless CI
      # this is crucial for undetected-chromedriver to avoid detection
      - name: üöÄ Run Python Scraper (with Xvfb)
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          xvfb-run --auto-servernum --server-args="-screen 0 1280x1024x24" npm run scrape:maximum:full
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          # No Gemini key needed for this specific hybrid script, but good to have if we expand
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      # 4. Post-Process (Badge assignment, brand sorting, etc.)
      - name: üîß Post-Process (Brands & Badges)
        if: always()
        run: |
          npm run fix:brands
          npx tsx src/garbageCollector.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
