name: Periodic Scraper & Auto-Fix

on:
  schedule:
    - cron: '1 0 1,8,15,22 * *'  # Her ayƒ±n 1, 8, 15, 22'sinde 03:01 TR
  workflow_dispatch:
    inputs:
      # Yapƒ± Kredi Cards
      run_world:
        description: 'World Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_adios:
        description: 'Adios Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_play:
        description: 'Play Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_crystal:
        description: 'Crystal Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      # Akbank Cards
      run_axess:
        description: 'Axess Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_free:
        description: 'Free Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_wings:
        description: 'Wings Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      # Other Cards
      run_bonus:
        description: 'Bonus Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_maximum:
        description: 'Maximum Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_vakifbank_world:
        description: 'Vakƒ±fBank World'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_bankkart:
        description: 'Bankkart'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_paraf:
        description: 'Paraf Card'
        default: 'false'
        type: choice
        options: ['true', 'false']

jobs:
  scrape-and-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # YAPI KREDƒ∞ CARDS
      - name: üí≥ World Card
        if: github.event.inputs.run_world != 'false'
        run: npx tsx src/scrapers/yapikredi/world.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üí≥ Adios Card
        if: github.event.inputs.run_adios != 'false'
        run: npx tsx src/scrapers/yapikredi/adios.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üí≥ Play Card
        if: github.event.inputs.run_play != 'false'
        run: npx tsx src/scrapers/yapikredi/play.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üí≥ Crystal Card
        if: github.event.inputs.run_crystal != 'false'
        run: npx tsx src/scrapers/yapikredi/crystal.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      # AKBANK CARDS
      - name: üí≥ Axess Card
        if: github.event.inputs.run_axess != 'false'
        run: npx tsx src/scrapers/akbank/axess.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üí≥ Free Card
        if: github.event.inputs.run_free != 'false'
        run: npx tsx src/scrapers/akbank/free.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üí≥ Wings Card
        if: github.event.inputs.run_wings != 'false'
        run: npx tsx src/scrapers/akbank/wings.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      # OTHER CARDS
      - name: üí≥ Bonus Card
        if: github.event.inputs.run_bonus != 'false'
        run: npx tsx src/scrapers/garanti/bonus.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üí≥ Maximum Card
        if: github.event.inputs.run_maximum != 'false'
        run: npx tsx src/scrapers/isbankasi/maximum.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üí≥ Vakƒ±fBank World
        if: github.event.inputs.run_vakifbank_world != 'false'
        run: npx tsx src/scrapers/vakifbank/world.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üí≥ Bankkart
        if: github.event.inputs.run_bankkart != 'false'
        run: npx tsx src/scrapers/ziraat/bankkart.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üí≥ Paraf Card
        if: github.event.inputs.run_paraf != 'false'
        run: npx tsx src/scrapers/halkbank/paraf.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      # POST-PROCESSING
      - name: üîß Run Auto-Fix Pipeline (Pass 1)
        run: npx tsx src/services/autoFixer.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üîß Run Auto-Fix Pipeline (Pass 2)
        run: npx tsx src/services/autoFixer.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üóëÔ∏è Run Garbage Collector
        run: npx tsx src/garbageCollector.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
