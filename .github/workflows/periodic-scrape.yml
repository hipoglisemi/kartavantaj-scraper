name: Periodic Scraper & Auto-Fix

on:
  schedule:
    - cron: '1 0 1,15 * *'  # Her ayƒ±n 1 ve 15'inde 03:01 TR
  workflow_dispatch:
    inputs:
      # Yapƒ± Kredi Cards
      run_world:
        description: 'World Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_adios:
        description: 'Adios Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_play:
        description: 'Play Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_crystal:
        description: 'Crystal Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      # Akbank Cards
      run_axess:
        description: 'Axess Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_free:
        description: 'Free Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_wings:
        description: 'Wings Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      # Other Cards
      run_bonus:
        description: 'Bonus Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_maximum:
        description: 'Maximum Card'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_vakifbank_world:
        description: 'Vakƒ±fBank World'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_bankkart:
        description: 'Bankkart'
        default: 'false'
        type: choice
        options: ['true', 'false']
      run_paraf:
        description: 'Paraf Card'
        default: 'false'
        type: choice
        options: ['true', 'false']

jobs:
  scrape:
    name: Scrape ${{ matrix.group }}
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        group: 
          - world            # Yapƒ± Kredi World (Longest)
          - axess            # Akbank Axess (Long)
          - bonus            # Garanti Bonus (Longest ~1h)
          - maximum          # ƒ∞≈ü Bankasƒ± Maximum
          - yapikredi-lite   # Adios, Play, Crystal
          - akbank-lite      # Wings, Free
          - ziraat           # Ziraat Bankkart
          - halkbank         # Halkbank Paraf
          - vakifbank        # Vakƒ±fBank World

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # --- YAPI KREDƒ∞ ---
      - name: üí≥ Run World Card (World Kart Tarama)
        if: matrix.group == 'world' && (github.event_name == 'schedule' || inputs.run_world == 'true')
        run: npx tsx src/scrapers/yapikredi/world.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üí≥ Run YK Lite (Diƒüer YK Kartlar - Adios, Play, Crystal)
        if: matrix.group == 'yapikredi-lite'
        run: |
          if [[ "${{ github.event_name }}" == "schedule" || "${{ inputs.run_adios }}" == "true" ]]; then npx tsx src/scrapers/yapikredi/adios.ts --ai; fi
          if [[ "${{ github.event_name }}" == "schedule" || "${{ inputs.run_play }}" == "true" ]]; then npx tsx src/scrapers/yapikredi/play.ts --ai; fi
          if [[ "${{ github.event_name }}" == "schedule" || "${{ inputs.run_crystal }}" == "true" ]]; then npx tsx src/scrapers/yapikredi/crystal.ts --ai; fi
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      # --- AKBANK ---
      - name: üí≥ Run Axess (Axess Kart Tarama)
        if: matrix.group == 'axess' && (github.event_name == 'schedule' || inputs.run_axess == 'true')
        run: npx tsx src/scrapers/akbank/axess.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üí≥ Run Akbank Lite (Diƒüer Akbank Kartlar - Wings, Free)
        if: matrix.group == 'akbank-lite'
        run: |
          if [[ "${{ github.event_name }}" == "schedule" || "${{ inputs.run_wings }}" == "true" ]]; then npx tsx src/scrapers/akbank/wings.ts --ai; fi
          if [[ "${{ github.event_name }}" == "schedule" || "${{ inputs.run_free }}" == "true" ]]; then npx tsx src/scrapers/akbank/free.ts --ai; fi
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      # --- OTHERS ---
      - name: üí≥ Run Bonus (Bonus Kart Tarama)
        if: matrix.group == 'bonus' && (github.event_name == 'schedule' || inputs.run_bonus == 'true')
        run: npx tsx src/scrapers/garanti/bonus.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üí≥ Run Maximum (Maximum Kart Tarama)
        if: matrix.group == 'maximum' && (github.event_name == 'schedule' || inputs.run_maximum == 'true')
        run: npx tsx src/scrapers/isbankasi/maximum.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üí≥ Run State Banks - Ziraat Bankkart
        if: matrix.group == 'ziraat' && (github.event_name == 'schedule' || inputs.run_bankkart == 'true')
        run: npx tsx src/scrapers/ziraat/bankkart.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üí≥ Run State Banks - Halkbank Paraf
        if: matrix.group == 'halkbank' && (github.event_name == 'schedule' || inputs.run_paraf == 'true')
        run: npx tsx src/scrapers/halkbank/paraf.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üí≥ Run State Banks - Vakƒ±fBank World
        if: matrix.group == 'vakifbank' && (github.event_name == 'schedule' || inputs.run_vakifbank_world == 'true')
        run: npx tsx src/scrapers/vakifbank/world.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

  post-process:
    name: üîß Finalize & Auto-Fix
    needs: scrape
    runs-on: ubuntu-latest
    if: always() # Run even if one scraper fails, to try and fix what succeeded
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: üîß Run Auto-Fix Pipeline (Otomatik D√ºzeltme - Tur 1)
        run: npx tsx src/services/autoFixer.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}
      
      - name: üîß Run Auto-Fix Pipeline (Otomatik D√ºzeltme - Tur 2)
        run: npx tsx src/services/autoFixer.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: üè∑Ô∏è Sync & Fix Brands (Marka E≈üle≈ütirme)
        run: npm run fix:brands
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

      - name: üóëÔ∏è Run Garbage Collector (√á√∂p Temizliƒüi)
        run: npx tsx src/garbageCollector.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
