name: Periodic Scraper & Auto-Fix

on:
  schedule:
    # Her ayÄ±n 1, 8, 15 ve 22'sinde saat 00:01'de Ã§alÄ±ÅŸÄ±r (UTC)
    # TÃ¼rkiye saati ile (UTC+3) 03:01'e denk gelir.
    - cron: '1 0 1,8,15,22 * *'
  # Manuel tetiklemek isterseniz 'Run workflow' butonu iÃ§in:
  workflow_dispatch:

jobs:
  scrape-and-fix:
    runs-on: ubuntu-latest
    
    # Maksimum Ã§alÄ±ÅŸma sÃ¼resi (Dakika). 
    # 5000 kampanya iÃ§in artÄ±rÄ±labilir, ÅŸimdilik 360 (6 saat) yeterli.
    timeout-minutes: 360

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ðŸš€ Run YapÄ± Kredi Scraper (World, Adios, Play, Crystal)
        run: npx ts-node src/scrapers/yapikredi.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: ðŸš€ Run Akbank Scraper (Axess, Free, Wings)
        run: npx ts-node src/scrapers/akbank.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: ðŸš€ Run Ä°ÅŸ BankasÄ± Scraper (Maximum)
        run: npx ts-node src/scrapers/isbankasi.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      # Gelecekte diÄŸer bankalarÄ± buraya ekleyebilirsiniz
      # - name: ðŸš€ Run Maximum Scraper
      #   run: npx ts-node src/scrapers/maximum.ts --ai

      - name: ðŸ”§ Run Auto-Fix Pipeline (Pass 1)
        run: npx ts-node src/qualityPipeline.ts --autofix
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: ðŸ”§ Run Auto-Fix Pipeline (Pass 2 - Double Check)
        # Ä°lk geÃ§iÅŸte dÃ¼zelmeyen varsa tekrar dene (Tam kontrol)
        run: npx ts-node src/qualityPipeline.ts --autofix
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: ðŸ§¹ Run Garbage Collector (Delete Expired > 10 Days)
        run: npx ts-node src/garbageCollector.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
