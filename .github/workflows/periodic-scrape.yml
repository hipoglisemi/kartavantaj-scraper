name: Periodic Scraper & Auto-Fix

on:
  schedule:
    # Her ayÄ±n 1, 8, 15 ve 22'sinde saat 00:01'de Ã§alÄ±ÅŸÄ±r (UTC)
    # TÃ¼rkiye saati ile (UTC+3) 03:01'e denk gelir.
    - cron: '1 0 1,8,15,22 * *'
  # Manuel tetiklemek isterseniz 'Run workflow' butonu iÃ§in:
  workflow_dispatch:
    inputs:
      run_yapikredi:
        description: 'YapÄ± Kredi (World, Adios, Play, Crystal)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      run_akbank:
        description: 'Akbank (Axess, Wings, Free)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      run_isbankasi:
        description: 'Ä°ÅŸ BankasÄ± (Maximum)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      run_garantibbva:
        description: 'Garanti BBVA (Bonus)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      run_halkbank:
        description: 'Halkbank (Paraf)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      run_vakifbank:
        description: 'VakÄ±fBank (World)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      run_ziraat:
        description: 'Ziraat BankasÄ± (Bankkart)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      run_autofix:
        description: 'Auto-Fix Pipeline Ã‡alÄ±ÅŸtÄ±r'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      run_garbage_collector:
        description: 'Garbage Collector Ã‡alÄ±ÅŸtÄ±r'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  scrape-and-fix:
    runs-on: ubuntu-latest
    
    # Maksimum Ã§alÄ±ÅŸma sÃ¼resi (Dakika). 
    # 5000 kampanya iÃ§in artÄ±rÄ±labilir, ÅŸimdilik 360 (6 saat) yeterli.
    timeout-minutes: 360

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Scraper'lar SIRAYLA Ã§alÄ±ÅŸÄ±r - her biri bitmeden bir sonraki baÅŸlamaz
      # Her scraper kendi kampanyalarÄ±nÄ± Supabase'e yazar
      
      - name: ğŸš€ Run YapÄ± Kredi Scraper (World, Adios, Play, Crystal)
        if: github.event.inputs.run_yapikredi != 'false'
        run: npx tsx src/scrapers/yapikredi.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: â¸ï¸ Wait for Supabase (YapÄ± Kredi)
        if: github.event.inputs.run_yapikredi != 'false'
        run: sleep 5

      - name: ğŸš€ Run Akbank Scraper (Axess, Free, Wings)
        if: github.event.inputs.run_akbank != 'false'
        run: npx tsx src/scrapers/akbank.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: â¸ï¸ Wait for Supabase (Akbank)
        if: github.event.inputs.run_akbank != 'false'
        run: sleep 5

      - name: ğŸš€ Run Ä°ÅŸ BankasÄ± Scraper (Maximum)
        if: github.event.inputs.run_isbankasi != 'false'
        run: npx tsx src/scrapers/isbankasi.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: â¸ï¸ Wait for Supabase (Ä°ÅŸ BankasÄ±)
        if: github.event.inputs.run_isbankasi != 'false'
        run: sleep 5

      - name: ğŸš€ Run Garanti BBVA Scraper (Bonus)
        if: github.event.inputs.run_garantibbva != 'false'
        run: npx tsx src/scrapers/garantibbva.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: â¸ï¸ Wait for Supabase (Garanti BBVA)
        if: github.event.inputs.run_garantibbva != 'false'
        run: sleep 5

      - name: ğŸš€ Run Halkbank Scraper (Paraf)
        if: github.event.inputs.run_halkbank != 'false'
        run: npx tsx src/scrapers/halkbank.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: â¸ï¸ Wait for Supabase (Halkbank)
        if: github.event.inputs.run_halkbank != 'false'
        run: sleep 5

      - name: ğŸš€ Run VakÄ±fBank Scraper (World)
        if: github.event.inputs.run_vakifbank != 'false'
        run: npx tsx src/scrapers/vakifbank.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: â¸ï¸ Wait for Supabase (VakÄ±fBank)
        if: github.event.inputs.run_vakifbank != 'false'
        run: sleep 5

      - name: ğŸš€ Run Ziraat BankasÄ± Scraper (Bankkart)
        if: github.event.inputs.run_ziraat != 'false'
        run: npx tsx src/scrapers/ziraat.ts --ai
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: â¸ï¸ Wait for Supabase (Ziraat)
        if: github.event.inputs.run_ziraat != 'false'
        run: sleep 5

      # Gelecekte diÄŸer bankalarÄ± buraya ekleyebilirsiniz
      # - name: ğŸš€ Run Maximum Scraper
      #   run: npx ts-node src/scrapers/maximum.ts --ai

      - name: ğŸ”§ Run Auto-Fix Pipeline (Pass 1)
        run: npx tsx src/services/autoFixer.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: ğŸ”§ Run Auto-Fix Pipeline (Pass 2 - Double Check)
        # Ä°lk geÃ§iÅŸte dÃ¼zelmeyen varsa tekrar dene (Tam kontrol)
        run: npx tsx src/services/autoFixer.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_GEMINI_KEY: ${{ secrets.GOOGLE_GEMINI_KEY }}

      - name: ğŸ—‘ï¸ Run Garbage Collector
        if: github.event.inputs.run_garbage_collector != 'false'
        run: npx tsx src/garbageCollector.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
